<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Semanal da Igreja AD Mazag√£o Velho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .calendar-event-dot { 
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 3px; 
            margin-top: 3px;
            flex-shrink: 0;
        }
        .calendar-event-text-desktop { 
            line-height: 1.3;
        }
        .calendar-event-text-mobile {
            font-size: 0.75rem; 
            line-height: 1.2;
            padding: 2px 4px;
            border-radius: 0.25rem;
            margin-top: 2px;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Cores para tipos de evento */
        .bg-event-culto { background-color: #ef4444; } /* red-500 */
        .bg-event-ebd { background-color: #6366f1; } /* indigo-500 */
        .bg-event-oracao { background-color: #14b8a6; } /* teal-500 */
        .bg-event-jovens { background-color: #f97316; } /* orange-500 */
        .bg-event-familia { background-color: #a855f7; } /* purple-500 */
        .bg-event-doutrina { background-color: #0ea5e9; } /* sky-500 */
        .bg-event-informatica { background-color: #f59e0b; } 
        .bg-event-informatica-neon { background-color: #39FF14; color: #000000 !important; }
        .bg-event-especial { background-color: #d946ef; } /* fuchsia-500 */

        .text-event-aniversario { color: #ec4899; } /* pink-500 */

        button:focus-visible, [role="button"]:focus-visible, a:focus-visible {
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
        }
        .day-cell:focus-within {
            outline: 2px solid #3b82f6; 
            outline-offset: -1px; 
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading-placeholder {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            min-height: 20px;
        }
        .loading-placeholder-text {
            color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-6">

    <header class="fixed top-0 left-0 w-full bg-white/90 backdrop-blur-lg shadow-sm z-50 px-4 md:px-6 pt-6 pb-4 border-b border-gray-200">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">AD MAZAG√ÉO VELHO</h1>
            <p class="text-md md:text-lg text-gray-600 mt-1">Organiza√ß√£o Semanal e Eventos</p>
        </div>
    </header>

    <main class="pt-28 md:pt-32">
        <div class="max-w-7xl mx-auto space-y-8">

            <section class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-200" aria-labelledby="cleaning-heading">
                 <div class="flex justify-between items-center mb-4">
                    <h2 id="cleaning-heading" class="text-xl font-semibold text-gray-700 flex items-center">
                        <svg class="w-8 h-8 mr-3 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg>
                        Escala de Limpeza Semanal
                    </h2>
                    <button id="copy-cleaning-schedule" aria-label="Copiar escala de limpeza" data-original-label="Copiar escala de limpeza" class="p-2 rounded-lg hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors">
                        <span class="copy-icon-placeholder text-xl">üìã</span>
                    </button>
                </div>
                <div id="cleaning-schedule" class="space-y-3 text-sm" aria-live="polite">
                     <p class="loading-placeholder-text">Carregando escala de limpeza...</p>
                     <div class="loading-placeholder h-8 w-full"></div>
                     <div class="loading-placeholder h-8 w-full mt-2"></div>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-200" aria-labelledby="calendar-heading">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 id="calendar-heading" class="text-xl font-semibold text-gray-700 flex items-center mb-2 sm:mb-0">
                        <svg class="w-8 h-8 mr-3 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" /></svg>
                        <span id="calendar-month-year" class="text-xl font-semibold text-gray-700">Carregando...</span>
                    </h2>
                    <div class="flex space-x-1">
                        <button id="prev-month" aria-label="M√™s anterior" class="p-2 rounded-lg hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <button id="next-month" aria-label="Pr√≥ximo m√™s" class="p-2 rounded-lg hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
                        </button>
                    </div>
                </div>
                <div id="calendar-header-days" class="hidden md:grid grid-cols-7 gap-1 text-xs font-semibold text-gray-500 text-center mb-1"> 
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
                </div>
                <div id="calendar-days" class="grid grid-cols-1 md:grid-cols-7 gap-2 md:gap-1" role="grid" aria-live="polite"> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div> 
                    <div class="loading-placeholder min-h-[70px] sm:min-h-[90px] md:min-h-[100px]"></div>
                </div>
                <div class="mt-4 space-x-2 space-y-1 text-xs text-gray-600 flex flex-wrap" aria-label="Legenda de eventos">
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-culto"></span>Culto</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-ebd"></span>EBD</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-oracao"></span>Ora√ß√£o</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-jovens"></span>Jovens</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-familia"></span>Fam√≠lia</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-doutrina"></span>Doutrina</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-informatica-neon"></span>Inform√°tica</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="w-2.5 h-2.5 rounded-full mr-1.5 flex-shrink-0 bg-event-especial"></span>Especial</span>
                    <span class="inline-flex items-center mr-2 mb-1"><span class="text-event-aniversario font-bold">üéÇ</span> Anivers√°rio</span>
                </div>
            </section>

            <section class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 border border-gray-200" aria-labelledby="birthdays-heading">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="birthdays-heading" class="text-xl font-semibold text-gray-700 flex items-center">
                        <span class="text-2xl mr-3" aria-hidden="true">üéÇ</span>
                        Aniversariantes da Semana
                    </h2>
                    <div class="flex space-x-1">
                        <button id="copy-birthdays-summary" aria-label="Copiar resumo de aniversariantes" data-original-label="Copiar resumo de aniversariantes" class="p-2 rounded-lg hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors">
                             <span class="copy-icon-placeholder text-xl">üìã</span>
                        </button>
                        <button id="download-birthdays" aria-label="Baixar resumo de aniversariantes em formato TXT" class="p-2 rounded-lg hover:bg-gray-200 text-gray-500 hover:text-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="birthdays" class="space-y-3 text-sm" aria-live="polite">
                     <p class="loading-placeholder-text">Carregando aniversariantes...</p>
                     <div class="loading-placeholder h-8 w-full"></div>
                     <div class="loading-placeholder h-8 w-full mt-2"></div>
                </div>
            </section>
        </div>
    </main>

    <script>
    const PainelIgrejaApp = {
        config: {
            panelReferenceDate: new Date(), 
            diasDaSemana: ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"],
            diasDaSemanaAbrev: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"], 
            mesesDoAno: ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
            startOfWeekMonday: true, 
            principalEventTypes: ['culto', 'jovens', 'familia', 'doutrina', 'especial'],
            eventTypeColors: {
                culto: 'bg-event-culto',
                ebd: 'bg-event-ebd',
                oracao: 'bg-event-oracao',
                jovens: 'bg-event-jovens',
                familia: 'bg-event-familia',
                doutrina: 'bg-event-doutrina',
                informatica: 'bg-event-informatica-neon', 
                especial: 'bg-event-especial', 
                default: 'bg-gray-400'
            },
            eventTypeMainTextColors: { 
                culto: 'text-red-600',
                jovens: 'text-orange-600',
                familia: 'text-purple-600',
                doutrina: 'text-sky-600',
                informatica: 'text-black', 
                especial: 'text-fuchsia-600',
                default: 'text-blue-600'
            },
            maxEventsToShowInCalendarCellMobile: 3, 
        },
        state: {
            currentDisplayDate: null, 
            allProcessedEvents: [], 
            isMobileView: window.innerWidth < 768, 
            currentCalendarViewMode: 'month', 
            currentWeekStartDate: null, 
        },
        data: {
            cleaningScheduleDefinition: [ 
                { dayOfWeek: 1, responsible: ["Piedade", "Jo√£o Paulo"] },    
                { dayOfWeek: 2, responsible: ["Iara", "Sebasti√£o Pacheco"] },
                { dayOfWeek: 3, responsible: ["Tain√°", "Aldaline"] },       
                { dayOfWeek: 4, responsible: ["Ana Aguiar", "N√∫bia"] },      
                { dayOfWeek: 5, responsible: ["Deuzarina", "Quirlene"] },    
                { dayOfWeek: 6, responsible: ["Marta", "Juliana Almeida"] }, 
                { dayOfWeek: 0, responsible: ["Niro", "Pedro Chagas"] }       
            ],
            birthdays: [
                { name: "Lucas Mendes", date: "2025-05-28" },
                { name: "Fernanda Costa", date: "2025-06-01" },
                { name: "Ricardo Alves", date: "2025-05-30"},
                { name: "Beatriz Almeida", date: "2025-06-05" },
                { name: "Jo√£o Silva", date: "2025-07-15" },
            ],
            churchEventsBase: [ 
                { date: "2025-05-11", time: "19:00", type: "especial", title: "Culto Especial Dia das M√£es" },
                { date: "2025-08-10", time: "19:00", type: "especial", title: "Culto Especial Dia dos Pais" },
            ],
            recurringEventRules: [
                { type: "ebd", title: "Escola B√≠blica Dominical", dayOfWeek: 0, time: "09:00" },
                { type: "doutrina", title: "Culto de Doutrina", dayOfWeek: 2, time: "19:30" }, 
                { type: "familia", title: "Culto da Fam√≠lia", dayOfWeek: 4, time: "19:30" }, 
                { type: "oracao", title: "Ora√ß√£o Semanal", dayOfWeek: 1, time: "19:00" }, 
                { type: "oracao", title: "Ora√ß√£o", dayOfWeek: 2, time: "18:00" }, 
                { type: "oracao", title: "Ora√ß√£o", dayOfWeek: 3, time: "18:00" }, 
                { type: "oracao", title: "Ora√ß√£o", dayOfWeek: 4, time: "18:00" }, 
                { type: "informatica", title: "Curso de Inform√°tica", dayOfWeek: 5, time: "19:00", obs: "Inscri√ß√µes abertas" }, 
                { type: "jovens", title: "Culto Jovem", dayOfWeek: 6, time: "19:30" }, 
                { type: "culto", title: "Culto de Domingo", dayOfWeek: 0, time: "19:00" } 
            ]
        },

        utils: {
            parseDate: (dateString) => {
                if (!dateString) return null;
                const parts = dateString.split(/[-/]/);
                if (parts.length !== 3) return null;
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; 
                const day = parseInt(parts[2]);
                if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
                return new Date(year, month, day);
            },
            formatDate: (dateObj, format = "DD/MM/AAAA") => {
                if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return "";
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0'); 
                const year = dateObj.getFullYear();
                if (format === "AAAA-MM-DD") return `${year}-${month}-${day}`;
                return `${day}/${month}/${year}`;
            },
            formatTime: (timeString) => { 
                 if (!timeString) return "";
                 const [hours, minutes] = timeString.split(':');
                 return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            },
            addMinutesToTime: (timeString, minutesToAdd) => {
                 const [hours, minutes] = timeString.split(':').map(Number);
                 const date = new Date(); 
                 date.setHours(hours, minutes, 0, 0);
                 date.setMinutes(date.getMinutes() + minutesToAdd);
                 return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            },
            createElement: (tag, classList = [], attributes = {}, textContent = null, innerHTML = null) => {
                const el = document.createElement(tag);
                const flatClassList = classList.flatMap(c => (typeof c === 'string' ? c.split(' ') : []))
                                               .filter(c => c); 
                if (flatClassList.length > 0) {
                    el.classList.add(...flatClassList);
                }
                for (const key in attributes) {
                    el.setAttribute(key, attributes[key]);
                }
                if (textContent) el.textContent = textContent;
                if (innerHTML) el.innerHTML = innerHTML;
                return el;
            },
            getNthDayOfMonth: (year, month, dayOfWeek, n) => { 
                 const date = new Date(year, month, 1); 
                 let occurrences = 0;
                 while(date.getDay() !== dayOfWeek && date.getMonth() === month) {
                     date.setDate(date.getDate() + 1);
                 }
                 if (date.getMonth() !== month) return null; 

                 while(date.getMonth() === month) {
                     occurrences++;
                     if (occurrences === n) return new Date(date); 
                     date.setDate(date.getDate() + 7); 
                 }
                 return null; 
            },
            getLastDayOfWeekInMonth: (year, month, dayOfWeek) => {
                let date = new Date(year, month + 1, 0); 
                while (date.getDay() !== dayOfWeek) {
                    date.setDate(date.getDate() - 1);
                }
                return date;
            },
            getStartOfWeek: function(date, startOnMonday) { 
                const d = new Date(date);
                const day = d.getDay(); 
                let diff;
                if (startOnMonday) {
                    diff = d.getDate() - (day === 0 ? 6 : day - 1);
                } else {
                    diff = d.getDate() - day;
                }
                return new Date(d.setDate(diff));
            }
        },

        renderCleaningSchedule: function() {
            const scheduleContainer = document.getElementById('cleaning-schedule');
            if (!scheduleContainer) { console.error("Elemento #cleaning-schedule n√£o encontrado."); return; }
            scheduleContainer.innerHTML = '<p class="loading-placeholder-text">Carregando...</p>'; 
            const todayDayOfWeek = this.config.panelReferenceDate.getDay();
            const fragment = document.createDocumentFragment();

            const orderedSchedule = [...this.data.cleaningScheduleDefinition].sort((a, b) => {
                let dayA = a.dayOfWeek;
                let dayB = b.dayOfWeek;
                if (this.config.startOfWeekMonday) { 
                    dayA = (dayA === 0) ? 7 : dayA; 
                    dayB = (dayB === 0) ? 7 : dayB;
                }
                return dayA - dayB;
            });

            orderedSchedule.forEach(item => {
                const isCurrentDay = item.dayOfWeek === todayDayOfWeek;
                const itemDivClasses = ['py-2', 'pl-3', 'border-l-4'];
                if (isCurrentDay) {
                    itemDivClasses.push('border-blue-500', 'bg-blue-50', 'rounded-r-md');
                } else {
                    itemDivClasses.push('border-gray-300');
                }
                const itemDiv = this.utils.createElement('div', itemDivClasses);

                let dayName = this.config.diasDaSemana[item.dayOfWeek];
                if (isCurrentDay) dayName += " (Hoje)";
                
                const pDay = this.utils.createElement('p', ['font-semibold', isCurrentDay ? 'text-blue-600' : 'text-gray-800'], {}, dayName);
                const responsibleText = Array.isArray(item.responsible) ? item.responsible.join(' e ') : item.responsible;
                const pResponsible = this.utils.createElement('p', ['text-xs', 'text-gray-600'], {}, null, `<span class="font-medium">${responsibleText}</span>`);
                
                itemDiv.appendChild(pDay); 
                itemDiv.appendChild(pResponsible); 
                fragment.appendChild(itemDiv);
            });
            scheduleContainer.innerHTML = ''; 
            scheduleContainer.appendChild(fragment);
        },

        copyToClipboard: function(text, buttonElement, successIcon = '‚úÖ', originalIcon = 'üìã') {
            const originalAriaLabel = buttonElement.dataset.originalLabel || buttonElement.getAttribute('aria-label'); 
            navigator.clipboard.writeText(text)
                .then(() => {
                    if (buttonElement) {
                        const originalIconHTML = buttonElement.querySelector('.copy-icon-placeholder') ? buttonElement.querySelector('.copy-icon-placeholder').innerHTML : originalIcon;
                        buttonElement.innerHTML = `<span class="text-green-500 text-xl">${successIcon}</span>`;
                        buttonElement.setAttribute('aria-label', 'Copiado!');
                        setTimeout(() => {
                            buttonElement.innerHTML = `<span class="copy-icon-placeholder text-xl">${originalIconHTML}</span>`; 
                            buttonElement.setAttribute('aria-label', originalAriaLabel);
                        }, 2000);
                    }
                })
                .catch(err => {
                    console.error('Erro ao copiar (navigator.clipboard): ', err);
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; 
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        if (buttonElement) {
                             const originalIconHTML = buttonElement.querySelector('.copy-icon-placeholder') ? buttonElement.querySelector('.copy-icon-placeholder').innerHTML : originalIcon;
                            buttonElement.innerHTML = `<span class="text-green-500 text-xl">${successIcon}</span>`;
                            buttonElement.setAttribute('aria-label', 'Copiado!');
                            setTimeout(() => {
                                buttonElement.innerHTML = `<span class="copy-icon-placeholder text-xl">${originalIconHTML}</span>`;
                                buttonElement.setAttribute('aria-label', originalAriaLabel);
                            }, 2000);
                        }
                    } catch (execErr) {
                        console.error('Erro ao copiar com execCommand: ', execErr);
                        alert('Erro ao copiar. Por favor, copie manualmente.');
                    }
                    document.body.removeChild(textArea);
                });
        },

        copyCleaningScheduleToClipboard: function() {
            let textToCopy = "Escala de Limpeza Semanal:\n\n";
            const orderedSchedule = [...this.data.cleaningScheduleDefinition].sort((a, b) => {
                let dayA = a.dayOfWeek; let dayB = b.dayOfWeek;
                if (this.config.startOfWeekMonday) { dayA = (dayA === 0) ? 7 : dayA; dayB = (dayB === 0) ? 7 : dayB; }
                return dayA - dayB;
            });

            orderedSchedule.forEach(item => {
                const dayName = this.config.diasDaSemana[item.dayOfWeek];
                const responsibleText = Array.isArray(item.responsible) ? item.responsible.join(' e ') : item.responsible;
                textToCopy += `${dayName}: ${responsibleText}\n`;
            });
            const buttonElement = document.getElementById('copy-cleaning-schedule');
            this.copyToClipboard(textToCopy, buttonElement);
        },
        
        copyBirthdaysSummaryToClipboard: function() {
            const todayRef = new Date(this.config.panelReferenceDate); todayRef.setHours(0, 0, 0, 0);
            const startOfWeek = new Date(todayRef);
            const dayOffset = this.config.startOfWeekMonday ? (todayRef.getDay() === 0 ? -6 : 1 - todayRef.getDay()) : -todayRef.getDay();
            startOfWeek.setDate(todayRef.getDate() + dayOffset);
            const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23, 59, 59, 999);

            const weekBirthdays = this.data.birthdays
                .map(b => ({ ...b, parsedDate: this.utils.parseDate(b.date) }))
                .filter(b => b.parsedDate && b.parsedDate >= startOfWeek && b.parsedDate <= endOfWeek)
                .sort((a, b) => a.parsedDate - b.parsedDate);

            if (weekBirthdays.length === 0) {
                alert("Nenhum aniversariante na semana para copiar.");
                return;
            }

            let summaryText = `Aniversariantes da Semana (${this.utils.formatDate(startOfWeek)} - ${this.utils.formatDate(endOfWeek)}):\n\n`;
            weekBirthdays.forEach(b => {
                summaryText += `${b.name} - ${this.utils.formatDate(b.parsedDate)} (${this.config.diasDaSemana[b.parsedDate.getDay()]})\n`;
            });
            const buttonElement = document.getElementById('copy-birthdays-summary');
            this.copyToClipboard(summaryText, buttonElement);
        },

        renderBirthdays: function() {
            const birthdayContainer = document.getElementById('birthdays');
            if (!birthdayContainer) { console.error("Elemento #birthdays n√£o encontrado."); return; }
            birthdayContainer.innerHTML = '<p class="loading-placeholder-text">Carregando...</p>'; 
            
            const todayRef = new Date(this.config.panelReferenceDate); todayRef.setHours(0, 0, 0, 0);
            const startOfWeek = new Date(todayRef);
            const dayOffset = this.config.startOfWeekMonday ? 
                                (todayRef.getDay() === 0 ? -6 : 1 - todayRef.getDay()) : 
                                -todayRef.getDay();
            startOfWeek.setDate(todayRef.getDate() + dayOffset);
            
            const endOfWeek = new Date(startOfWeek); 
            endOfWeek.setDate(startOfWeek.getDate() + 6); 
            endOfWeek.setHours(23, 59, 59, 999);
            
            const fragment = document.createDocumentFragment();
            
            const allWeekBirthdays = this.data.birthdays
                .map(b => ({ ...b, parsedDate: this.utils.parseDate(b.date) }))
                .filter(b => b.parsedDate && b.parsedDate >= startOfWeek && b.parsedDate <= endOfWeek);

            const todaysBirthdays = allWeekBirthdays.filter(b => b.parsedDate.toDateString() === todayRef.toDateString());
            const otherWeekBirthdays = allWeekBirthdays
                .filter(b => b.parsedDate.toDateString() !== todayRef.toDateString())
                .sort((a, b) => a.parsedDate - b.parsedDate);

            const sortedWeekBirthdays = [...todaysBirthdays, ...otherWeekBirthdays];


            if (sortedWeekBirthdays.length === 0) {
                birthdayContainer.innerHTML = '<p class="text-gray-500 text-xs">Nenhum aniversariante nesta semana.</p>';
                return;
            }
            sortedWeekBirthdays.forEach(b => {
                const isToday = b.parsedDate.toDateString() === todayRef.toDateString();
                const itemDivClasses = ['py-2'];
                if (isToday) itemDivClasses.push('bg-pink-50', 'text-pink-700', 'rounded-md', 'p-2', 'font-semibold');

                const itemDiv = this.utils.createElement('div', itemDivClasses);
                let dateString = `${this.config.diasDaSemana[b.parsedDate.getDay()]}, ${b.parsedDate.getDate()} de ${this.config.mesesDoAno[b.parsedDate.getMonth()]}`;
                if (isToday) dateString += " (Hoje! üéâ)";
                
                const pName = this.utils.createElement('p', ['font-semibold', 'truncate', isToday ? 'text-pink-700' : 'text-gray-800'], {title: b.name}, b.name); 
                const pDate = this.utils.createElement('p', ['text-xs', isToday ? 'text-pink-600' : 'text-gray-600'], {}, dateString);
                
                itemDiv.appendChild(pName); 
                itemDiv.appendChild(pDate); 
                fragment.appendChild(itemDiv);
            });
            birthdayContainer.innerHTML = ''; 
            birthdayContainer.appendChild(fragment);
        },

        downloadBirthdaysSummary: function() {
            const todayRef = new Date(this.config.panelReferenceDate); todayRef.setHours(0, 0, 0, 0);
            const startOfWeek = new Date(todayRef);
            const dayOffset = this.config.startOfWeekMonday ? (todayRef.getDay() === 0 ? -6 : 1 - todayRef.getDay()) : -todayRef.getDay();
            startOfWeek.setDate(todayRef.getDate() + dayOffset);
            const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23, 59, 59, 999);

            const weekBirthdays = this.data.birthdays
                .map(b => ({ ...b, parsedDate: this.utils.parseDate(b.date) }))
                .filter(b => b.parsedDate && b.parsedDate >= startOfWeek && b.parsedDate <= endOfWeek)
                .sort((a, b) => a.parsedDate - b.parsedDate);

            if (weekBirthdays.length === 0) {
                alert("Nenhum aniversariante na semana para baixar.");
                return;
            }

            let summaryText = `Aniversariantes da Semana (${this.utils.formatDate(startOfWeek)} - ${this.utils.formatDate(endOfWeek)}):\n\n`;
            weekBirthdays.forEach(b => {
                summaryText += `${b.name} - ${this.utils.formatDate(b.parsedDate)} (${this.config.diasDaSemana[b.parsedDate.getDay()]})\n`;
            });

            const blob = new Blob([summaryText], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `aniversariantes_semana_${this.utils.formatDate(startOfWeek, "DDMMYYYY")}_a_${this.utils.formatDate(endOfWeek, "DDMMYYYY")}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        },
        
        renderCalendar: function() {
            const calendarDaysContainer = document.getElementById('calendar-days');
            const calendarMonthYearEl = document.getElementById('calendar-month-year');
            const calendarHeaderDaysEl = document.getElementById('calendar-header-days');
            const prevButton = document.getElementById('prev-month');
            const nextButton = document.getElementById('next-month');

            if (!calendarDaysContainer || !calendarMonthYearEl || !calendarHeaderDaysEl || !prevButton || !nextButton) {
                console.error("Um ou mais elementos do calend√°rio n√£o foram encontrados.");
                return;
            }
            
            this.state.isMobileView = window.innerWidth < 768; 
            const isMobile = this.state.isMobileView;
            
            if (isMobile) {
                this.state.currentCalendarViewMode = 'week';
                if (!this.state.currentWeekStartDate) { 
                    this.state.currentWeekStartDate = this.utils.getStartOfWeek(new Date(this.config.panelReferenceDate), this.config.startOfWeekMonday);
                }
            } else {
                this.state.currentCalendarViewMode = 'month';
                if (!this.state.currentDisplayDate || this.state.currentCalendarViewMode === 'week') { 
                    this.state.currentDisplayDate = new Date(this.config.panelReferenceDate.getFullYear(), this.config.panelReferenceDate.getMonth(), 1);
                }
            }

            calendarDaysContainer.innerHTML = ''; 
            const fragment = document.createDocumentFragment();
            
            if (isMobile) {
                calendarHeaderDaysEl.classList.add('hidden'); 
                calendarDaysContainer.classList.remove('md:grid-cols-7', 'md:gap-1');
                calendarDaysContainer.classList.add('grid-cols-1', 'gap-3'); 

                const weekStart = new Date(this.state.currentWeekStartDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                let weekLabel = `Semana de ${this.utils.formatDate(weekStart)} a ${this.utils.formatDate(weekEnd)}`;
                
                const today = new Date(this.config.panelReferenceDate);
                today.setHours(0,0,0,0);
                if (today >= weekStart && today <= weekEnd) {
                    weekLabel += " (Semana Atual)";
                }
                calendarMonthYearEl.textContent = weekLabel;
                prevButton.setAttribute('aria-label', 'Semana anterior');
                nextButton.setAttribute('aria-label', 'Pr√≥xima semana');

                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + i);
                    const day = currentDate.getDate();
                    const month = currentDate.getMonth();
                    const year = currentDate.getFullYear();

                    const dayCellBaseClasses = ['day-cell', 'p-3', 'rounded-lg', 'border', 'flex', 'flex-col', 'transition-colors', 'relative', 'bg-white', 'border-gray-300', 'space-y-1.5', 'shadow'];
                    let ariaLabelDay = `${this.config.diasDaSemana[currentDate.getDay()]}, ${day} de ${this.config.mesesDoAno[month]}`;
                    const isToday = currentDate.toDateString() === this.config.panelReferenceDate.toDateString();
                    if (isToday) { 
                        dayCellBaseClasses.push('bg-blue-50', 'border-blue-400', 'ring-2', 'ring-blue-500'); 
                    }
                    
                    const dayEl = this.utils.createElement('div', dayCellBaseClasses); 
                    dayEl.setAttribute('role', 'listitem');
                    dayEl.setAttribute('tabindex', '0'); 

                    const dayHeaderContainer = this.utils.createElement('div', ['flex', 'justify-between', 'w-full', 'items-center', 'mb-2']);
                    const dayNumberClasses = ['font-semibold', 'p-0.5', 'leading-none', 'w-7', 'h-7', 'flex', 'items-center', 'justify-center', 'rounded-full', 'text-sm'];
                    if(isToday) {
                        dayNumberClasses.push('bg-blue-500', 'text-white');
                    } else {
                        dayNumberClasses.push('text-gray-700');
                    }
                    dayHeaderContainer.appendChild(this.utils.createElement('span', ['text-base', 'font-medium', isToday ? 'text-blue-700' : 'text-gray-700'], {}, this.config.diasDaSemana[currentDate.getDay()]));
                    dayHeaderContainer.appendChild(this.utils.createElement('span', dayNumberClasses, {}, day.toString()));
                    dayEl.appendChild(dayHeaderContainer);

                    const eventsDisplayContainer = this.utils.createElement('div', ['w-full', 'space-y-1.5', 'flex-grow']);
                    let eventInfosForAria = [];
                    
                    this.state.allProcessedEvents
                        .filter(e => e.date === this.utils.formatDate(currentDate, "AAAA-MM-DD"))
                        .forEach(event => {
                            const bgColorClass = this.config.eventTypeColors[event.type] || this.config.eventTypeColors.default;
                            let textColorClass = 'text-white';
                            if (event.type === 'informatica' && bgColorClass === 'bg-event-informatica-neon') {
                                textColorClass = 'text-black';
                            }
                            const eventDiv = this.utils.createElement('div', 
                                ['calendar-event-text-mobile', bgColorClass, textColorClass, 'flex', 'items-center'], 
                                { title: `${event.title} √†s ${this.utils.formatTime(event.time)}` }
                            );
                            eventDiv.innerHTML = `<span class="truncate">${this.utils.formatTime(event.time)} - ${event.title}</span>`;
                            eventsDisplayContainer.appendChild(eventDiv);
                            eventInfosForAria.push(`${event.title} √†s ${this.utils.formatTime(event.time)}`);
                        });

                    this.data.birthdays
                        .filter(b => {
                            const bDate = this.utils.parseDate(b.date);
                            return bDate && bDate.getDate() === day && bDate.getMonth() === month; 
                        })
                        .forEach(b => {
                            const bDayDiv = this.utils.createElement('div', 
                                ['flex', 'items-center', 'text-xs', 'px-1.5', 'py-1', 'rounded', 'bg-pink-100', 'w-full', 'mt-0.5'],
                                { title: `Anivers√°rio: ${b.name}` }
                            );
                            bDayDiv.innerHTML = `<span class="text-event-aniversario font-bold mr-1.5">üéÇ</span> <span class="text-pink-700">${b.name}</span>`;
                            eventsDisplayContainer.appendChild(bDayDiv); 
                            eventInfosForAria.push(`Anivers√°rio: ${b.name}`);
                        });
                    
                    dayEl.appendChild(eventsDisplayContainer);
                    if(eventInfosForAria.length > 0) { 
                        ariaLabelDay += `. Eventos: ${eventInfosForAria.join("; ")}`; 
                    } else {
                         eventsDisplayContainer.appendChild(this.utils.createElement('p', ['text-xs', 'text-gray-400', 'italic'], {}, 'Nenhum evento ou anivers√°rio.'));
                        ariaLabelDay += ". Nenhum evento ou anivers√°rio.";
                    }
                    dayEl.setAttribute('aria-label', ariaLabelDay); 
                    fragment.appendChild(dayEl);
                }

            } else { // Renderiza√ß√£o Mensal (Desktop)
                calendarHeaderDaysEl.classList.remove('hidden');
                calendarHeaderDaysEl.classList.add('md:grid');
                calendarDaysContainer.classList.remove('grid-cols-1', 'gap-3'); 
                calendarDaysContainer.classList.add('md:grid-cols-7', 'md:gap-1');
                calendarMonthYearEl.textContent = `${this.config.mesesDoAno[this.state.currentDisplayDate.getMonth()]} ${this.state.currentDisplayDate.getFullYear()}`;
                prevButton.setAttribute('aria-label', 'M√™s anterior');
                nextButton.setAttribute('aria-label', 'Pr√≥ximo m√™s');


                const year = this.state.currentDisplayDate.getFullYear(); 
                const month = this.state.currentDisplayDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                let startDayOfWeekIndex = firstDayOfMonth.getDay(); 
                let displayStartOffset = startDayOfWeekIndex; 
                const todayRef = new Date(this.config.panelReferenceDate); todayRef.setHours(0,0,0,0);
                const prevMonthLastDay = new Date(year, month, 0).getDate();

                for (let i = 0; i < displayStartOffset; i++) {
                    const day = prevMonthLastDay - displayStartOffset + 1 + i;
                    const dayEl = this.utils.createElement('div', ['day-cell', 'min-h-[70px]', 'sm:min-h-[90px]', 'md:min-h-[100px]', 'p-1', 'rounded-md', 'bg-gray-50', 'border', 'border-gray-200', 'flex', 'flex-col', 'items-start', 'text-xs', 'opacity-75']);
                    dayEl.setAttribute('role', 'gridcell');
                    dayEl.setAttribute('aria-label', `${day} (m√™s anterior)`);
                    dayEl.appendChild(this.utils.createElement('span', ['font-semibold', 'text-gray-400', 'self-end', 'p-1', 'leading-none'], {}, day.toString()));
                    fragment.appendChild(dayEl);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const dayClasses = ['day-cell', 'min-h-[70px]', 'sm:min-h-[90px]', 'md:min-h-[100px]', 'p-1', 'rounded-md', 'border', 'flex', 'flex-col', 'items-start', 'text-xs', 'hover:bg-gray-50', 'transition-colors', 'relative'];
                    let ariaLabelDay = `${day} de ${this.config.mesesDoAno[month]}, ${this.config.diasDaSemana[currentDate.getDay()]}`;
                    const isToday = currentDate.toDateString() === todayRef.toDateString();
                    if (isToday) { dayClasses.push('bg-blue-100', 'border-blue-300'); } else { dayClasses.push('bg-white', 'border-gray-200'); }
                    
                    const dayEl = this.utils.createElement('div', dayClasses); 
                    dayEl.setAttribute('role', 'gridcell');
                    dayEl.setAttribute('tabindex', '0'); 

                    const dayNumberClasses = ['font-semibold', 'self-end', 'p-0.5', 'leading-none', 'w-6', 'h-6', 'flex', 'items-center', 'justify-center', 'rounded-full', 'mb-0.5'];
                    if (isToday) { dayNumberClasses.push('bg-blue-500', 'text-white'); } else { dayNumberClasses.push('text-gray-700'); }
                    dayEl.appendChild(this.utils.createElement('span', dayNumberClasses, {}, day.toString()));

                    const eventsDisplayContainer = this.utils.createElement('div', ['w-full', 'mt-0.5', 'flex', 'flex-row', 'flex-wrap', 'items-start', 'gap-0.5', 'flex-grow', 'overflow-hidden']);
                    let eventInfosForAria = [];
                    const eventsOnThisDay = this.state.allProcessedEvents.filter(e => e.date === this.utils.formatDate(currentDate, "AAAA-MM-DD"));
                    
                    if (eventsOnThisDay.length > 0) {
                        const maxDots = this.config.maxEventsToShowInCalendarCellMobile;
                        for (let i = 0; i < Math.min(eventsOnThisDay.length, maxDots); i++) {
                            const event = eventsOnThisDay[i];
                            const bgColorClass = this.config.eventTypeColors[event.type] || this.config.eventTypeColors.default;
                            const eventDot = this.utils.createElement('div', 
                                ['calendar-event-dot', bgColorClass], 
                                { title: `${event.title} √†s ${this.utils.formatTime(event.time)}` }
                            );
                            eventsDisplayContainer.appendChild(eventDot);
                        }
                        if (eventsOnThisDay.length > maxDots) {
                            eventsDisplayContainer.appendChild(
                                this.utils.createElement('span', ['text-gray-500', 'text-[0.6rem]', 'ml-0.5', 'mt-1'], {}, `+${eventsOnThisDay.length - maxDots}`)
                            );
                        }
                        eventsOnThisDay.forEach(event => eventInfosForAria.push(`${event.title} √†s ${this.utils.formatTime(event.time)}`));
                    }

                    this.data.birthdays
                        .filter(b => { const bDate = this.utils.parseDate(b.date); return bDate && bDate.getDate() === day && bDate.getMonth() === month; })
                        .forEach(b => {
                            const bDayDiv = this.utils.createElement('div', 
                                ['flex', 'items-center', 'text-[0.65rem]', 'sm:text-[0.7rem]', 'px-1', 'py-0.5', 'rounded', 'bg-pink-100', 'w-full', 'mt-0.5'],
                                { title: `Anivers√°rio: ${b.name}` }
                            );
                            bDayDiv.innerHTML = `<span class="text-event-aniversario font-bold mr-1.5">üéÇ</span> <span class="text-pink-700 truncate">${b.name.split(' ')[0]}</span>`;
                            eventsDisplayContainer.appendChild(bDayDiv); 
                            eventInfosForAria.push(`Anivers√°rio: ${b.name}`);
                        });
                    
                    dayEl.appendChild(eventsDisplayContainer);
                    if(eventInfosForAria.length > 0) { ariaLabelDay += `. Eventos: ${eventInfosForAria.join("; ")}`; } else { ariaLabelDay += ". Nenhum evento ou anivers√°rio.";}
                    dayEl.setAttribute('aria-label', ariaLabelDay); 
                    fragment.appendChild(dayEl);
                }

                const totalCells = displayStartOffset + daysInMonth;
                const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
                for (let i = 1; i <= remainingCells; i++) {
                    const dayEl = this.utils.createElement('div', ['day-cell', 'min-h-[70px]', 'sm:min-h-[90px]', 'md:min-h-[100px]', 'p-1', 'rounded-md', 'bg-gray-50', 'border', 'border-gray-200', 'flex', 'flex-col', 'items-start', 'text-xs', 'opacity-75']);
                    dayEl.setAttribute('role', 'gridcell');
                    dayEl.setAttribute('aria-label', `${i} (pr√≥ximo m√™s)`);
                    dayEl.appendChild(this.utils.createElement('span', ['font-semibold', 'text-gray-400', 'self-end', 'p-1', 'leading-none'], {}, i.toString()));
                    fragment.appendChild(dayEl);
                }
            }
            calendarDaysContainer.appendChild(fragment);
        },

        setupEventListeners: function() {
            const prevButton = document.getElementById('prev-month');
            const nextButton = document.getElementById('next-month');
            const downloadBirthdaysBtn = document.getElementById('download-birthdays');
            const copyCleaningScheduleBtn = document.getElementById('copy-cleaning-schedule');
            const copyBirthdaysSummaryBtn = document.getElementById('copy-birthdays-summary');

            if (prevButton) {
                prevButton.addEventListener('click', () => {
                    if (this.state.currentCalendarViewMode === 'week') {
                        this.state.currentWeekStartDate.setDate(this.state.currentWeekStartDate.getDate() - 7);
                    } else { 
                        this.state.currentDisplayDate.setMonth(this.state.currentDisplayDate.getMonth() - 1);
                    }
                    this.renderCalendar();
                });
            }
            if (nextButton) {
                nextButton.addEventListener('click', () => {
                     if (this.state.currentCalendarViewMode === 'week') {
                        this.state.currentWeekStartDate.setDate(this.state.currentWeekStartDate.getDate() + 7);
                    } else { 
                        this.state.currentDisplayDate.setMonth(this.state.currentDisplayDate.getMonth() + 1);
                    }
                    this.renderCalendar();
                });
            }
            
            if (downloadBirthdaysBtn) downloadBirthdaysBtn.addEventListener('click', () => this.downloadBirthdaysSummary());
            if (copyCleaningScheduleBtn) copyCleaningScheduleBtn.addEventListener('click', () => this.copyCleaningScheduleToClipboard());
            if (copyBirthdaysSummaryBtn) copyBirthdaysSummaryBtn.addEventListener('click', () => this.copyBirthdaysSummaryToClipboard());
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    const newIsMobileView = window.innerWidth < 768;
                    if (newIsMobileView !== this.state.isMobileView) { 
                        this.state.isMobileView = newIsMobileView;
                        if(this.state.isMobileView){ 
                             this.state.currentWeekStartDate = this.utils.getStartOfWeek(new Date(this.state.currentDisplayDate), this.config.startOfWeekMonday); 
                        } else { 
                             if (this.state.currentWeekStartDate) {
                                this.state.currentDisplayDate = new Date(this.state.currentWeekStartDate.getFullYear(), this.state.currentWeekStartDate.getMonth(), 1);
                             } else { 
                                this.state.currentDisplayDate = new Date(this.config.panelReferenceDate.getFullYear(), this.config.panelReferenceDate.getMonth(), 1);
                             }
                             this.state.currentWeekStartDate = null; 
                        }
                        this.renderCalendar(); 
                    }
                }, 250); 
            });
        },

        init: function() {
            console.log("Painel da Igreja inicializando...");
            this.state.isMobileView = window.innerWidth < 768; 

            if (this.state.isMobileView) {
                this.state.currentCalendarViewMode = 'week';
                this.state.currentWeekStartDate = this.utils.getStartOfWeek(new Date(this.config.panelReferenceDate), this.config.startOfWeekMonday);
                this.state.currentDisplayDate = new Date(this.state.currentWeekStartDate); 
            } else {
                this.state.currentCalendarViewMode = 'month';
                this.state.currentDisplayDate = new Date(this.config.panelReferenceDate.getFullYear(), this.config.panelReferenceDate.getMonth(), 1);
            }
            
            let processedEvents = [...this.data.churchEventsBase]; 
            const refDate = this.config.panelReferenceDate;

            this.data.birthdays.push(
                 { name: "Ana Clara (Amanh√£ Teste)", date: this.utils.formatDate(new Date(new Date(refDate).setDate(refDate.getDate() + 1)), "AAAA-MM-DD") },
                 { name: "Carlos Eduardo (Em 3 Dias Teste)", date: this.utils.formatDate(new Date(new Date(refDate).setDate(refDate.getDate() + 3)), "AAAA-MM-DD") }
            );
            
            const startRecurrenceDate = new Date(refDate.getFullYear(), refDate.getMonth() -1, 1); 
            const endRecurrenceDate = new Date(refDate.getFullYear(), refDate.getMonth() + 3, 0); 

            this.data.recurringEventRules.forEach(rule => {
                if (rule.beforeEventType) return; 

                for (let d = new Date(startRecurrenceDate); d <= endRecurrenceDate; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() === rule.dayOfWeek) {
                        let shouldAddEvent = true;
                        if (rule.occurrence) { 
                            shouldAddEvent = false;
                            const dayInMonth = d.getDate();
                            const weekOfMonth = Math.ceil(dayInMonth / 7);
                            const occurrenceMap = { "first": 1, "second": 2, "third": 3, "fourth": 4 };
                            
                            if (rule.occurrence.includes("last")) {
                                let testLast = new Date(d);
                                testLast.setDate(testLast.getDate() + 7);
                                if(testLast.getMonth() !== d.getMonth() && d.getDay() === rule.dayOfWeek) shouldAddEvent = true;
                            }
                            for (const occ of rule.occurrence) {
                                if (occurrenceMap[occ] && weekOfMonth === occurrenceMap[occ]) {
                                    shouldAddEvent = true;
                                    break;
                                }
                            }
                        }

                        if (shouldAddEvent) {
                            const newEvent = {
                                date: this.utils.formatDate(d, "AAAA-MM-DD"),
                                time: rule.time,
                                type: rule.type,
                                title: rule.title,
                                obs: rule.obs || null,
                                local: rule.local || null,
                            };
                            processedEvents.push(newEvent);
                        }
                    }
                }
            });

            for (let d = new Date(startRecurrenceDate); d <= endRecurrenceDate; d.setDate(d.getDate() + 1)) {
                if (d.getDay() === 0) { 
                    const formattedDate = this.utils.formatDate(d, "AAAA-MM-DD");
                    const firstSunday = this.utils.getNthDayOfMonth(d.getFullYear(), d.getMonth(), 0, 1);
                    const secondSunday = this.utils.getNthDayOfMonth(d.getFullYear(), d.getMonth(), 0, 2);
                    const lastSunday = this.utils.getLastDayOfWeekInMonth(d.getFullYear(), d.getMonth(), 0);

                    let existingEventOnThisSunday = processedEvents.find(e => e.date === formattedDate && (e.type === 'culto' || e.type === 'especial'));
                    
                    if (firstSunday && d.getTime() === firstSunday.getTime() && (!existingEventOnThisSunday || existingEventOnThisSunday.title !== "Culto de Santa Ceia")) {
                        processedEvents = processedEvents.filter(e => !(e.date === formattedDate && e.title === "Culto de Domingo")); 
                        processedEvents.push({ date: formattedDate, time: "19:00", type: "especial", title: "Culto de Santa Ceia" }); 
                    } else if (secondSunday && d.getTime() === secondSunday.getTime() && (!existingEventOnThisSunday || existingEventOnThisSunday.title !== "Culto de Miss√£o")) {
                        processedEvents = processedEvents.filter(e => !(e.date === formattedDate && e.title === "Culto de Domingo"));
                        processedEvents.push({ date: formattedDate, time: "19:00", type: "culto", title: "Culto de Miss√£o" }); 
                    } else if (lastSunday && d.getTime() === lastSunday.getTime() && (!existingEventOnThisSunday || existingEventOnThisSunday.title !== "Culto de A√ß√£o Social")) {
                        processedEvents = processedEvents.filter(e => !(e.date === formattedDate && e.title === "Culto de Domingo"));
                        processedEvents.push({ date: formattedDate, time: "19:00", type: "culto", title: "Culto de A√ß√£o Social" }); 
                    } else if (!existingEventOnThisSunday) { 
                         const ruleDomingo = this.data.recurringEventRules.find(r => r.title === "Culto de Domingo" && r.dayOfWeek === 0); 
                         if (ruleDomingo) { 
                            processedEvents.push({
                                date: formattedDate, time: ruleDomingo.time, type: ruleDomingo.type, title: ruleDomingo.title,
                            });
                         }
                    }
                }
            }


            const preEventRules = this.data.recurringEventRules.filter(r => r.beforeEventType);
            if (preEventRules.length > 0) {
                const eventsToHavePreEvent = [...processedEvents]; 
                preEventRules.forEach(preRule => {
                    const targetEventTypes = Array.isArray(preRule.beforeEventType) ? preRule.beforeEventType : [preRule.beforeEventType];
                    eventsToHavePreEvent.forEach(mainEvent => {
                        if (targetEventTypes.includes(mainEvent.type)) {
                            processedEvents.push({
                                date: mainEvent.date,
                                time: this.utils.addMinutesToTime(mainEvent.time, preRule.timeOffsetMinutes),
                                type: preRule.type,
                                title: preRule.title,
                                durationMinutes: preRule.durationMinutes
                            });
                        }
                    });
                });
            }

            const uniqueEvents = new Map();
            processedEvents.forEach(event => {
                const key = `${event.date}-${event.time}-${event.title}`; 
                uniqueEvents.set(key, event); 
            });
            this.state.allProcessedEvents = Array.from(uniqueEvents.values())
                                               .sort((a,b) => {
                                                    const dateA = this.utils.parseDate(`${a.date}T${a.time || '00:00'}`);
                                                    const dateB = this.utils.parseDate(`${b.date}T${b.time || '00:00'}`);
                                                    if (!dateA && !dateB) return 0;
                                                    if (!dateA) return 1;
                                                    if (!dateB) return -1;
                                                    return dateA - dateB;
                                                });


            const requiredContainers = ['cleaning-schedule', 'birthdays', 'calendar-days', 'calendar-month-year'];
            let allContainersFound = true;
            requiredContainers.forEach(id => {
                const el = document.getElementById(id);
                if (!el) { 
                    console.error(`Elemento container #${id} n√£o encontrado.`);
                    allContainersFound = false;
                }
            });

            if (allContainersFound) {
                // Removida a chamada para renderNextEvent e renderWorshipSchedule
                // if (document.getElementById('next-event-details')) this.renderNextEvent(); // Descomente se quiser reativar
                this.renderCleaningSchedule();
                // if (document.getElementById('worship-schedule-details')) { /* this.renderWorshipSchedule(); */ } // Se√ß√£o removida
                this.renderBirthdays();
                this.renderCalendar(); 
                this.setupEventListeners();
                console.log("Painel da Igreja renderizado com sucesso.");
            } else {
                console.error("Renderiza√ß√£o abortada devido √† falta de containers HTML essenciais.");
                document.body.innerHTML = '<p class="text-center text-red-500 font-bold mt-10">Erro cr√≠tico: A estrutura da p√°gina est√° incompleta. Por favor, contate o suporte.</p>';
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        PainelIgrejaApp.init();
    });
    </script>

</body>
</html>
